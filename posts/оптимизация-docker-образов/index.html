<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		 
			
  
    <meta name="twitter:card" content="summary"/>
    
      <meta name="twitter:image" content="https://ealebed.github.io/images/avatar.png" />
    
  
  
  <meta name="twitter:title" content="Оптимизация docker-образов"/>
  <meta name="twitter:description" content="Как известно, docker-контейнеры создаются и запускаются из образов, которые можно загрузить из общедоступных репозиториев (например, Docker Hub) или собрать самостоятельно с помощью инструкций в Dockerfile.

"/>
  
    <meta name="twitter:site" content="@ealebed"/>
  
  
  
  
    <meta name="twitter:creator" content="@Evgen Lebed"/>
  



		
		<meta name="author" content="Evgen Lebed">
		<meta name="description" content="Evgen Lebed&#39;s website">
		<meta name="generator" content="Hugo 0.38.2" />
		<title>Оптимизация docker-образов &middot; Evgen Lebed&#39;s website</title>
		<link rel="shortcut icon" href="https://ealebed.github.io/images/favicon.ico">
		<link rel="stylesheet" href="https://ealebed.github.io/css/style.css">
		<link rel="stylesheet" href="https://ealebed.github.io/css/highlight.css">

		<link rel="stylesheet" href="https://ealebed.github.io/css/font-awesome.min.css">

		
	</head>

    <body>
       <nav class="main-nav">
	
	
		<a href='https://ealebed.github.io/'> <span class="arrow">←</span>Home</a>
	
	<a href='https://ealebed.github.io/posts'>Archive</a>
	<a href='https://ealebed.github.io/tags'>Tags</a>
	<a href='https://ealebed.github.io/about'>About</a>

	
</nav>


        <section id="wrapper" class="post">
            <article>
                <header>
                    <h1>
                        Оптимизация docker-образов
                    </h1>
                    <h2 class="headline">
                    Apr 13, 2017 13:57
                    · 1131 words
                    · 6 minute read
                      <span class="tags">
                      
                      
                          
                              <a href="https://ealebed.github.io/tags/docker">docker</a>
                          
                      
                      
                      </span>
                    </h2>
                </header>
                <section id="post-body">
                    <p>Как известно, docker-контейнеры создаются и запускаются из образов, которые можно загрузить из общедоступных репозиториев (например, <a href="https://hub.docker.com/">Docker Hub</a>) или собрать самостоятельно с помощью инструкций в Dockerfile.</p>

<p></p>

<p>Самостоятельная сборка образов, на мой взгляд, обладает целым рядом преимуществ, однако в результате можно получить образ неприлично большого размера. Давайте разберемся, <strong>как оптимизировать docker-образы</strong>, не жертвуя при этом их функциональностью!</p>

<p>Действия производятся на:</p>

<pre><code>lsb_release -a
No LSB modules are available.
Distributor ID:    Ubuntu
Description:    Ubuntu 16.04.2 LTS
Release:    16.04
Codename:    xenial
</code></pre>

<p>Используемая версия docker-engine:</p>

<pre><code>docker version
Client:
 Version:      17.03.0-ce
 API version:  1.26
 Go version:   go1.7.5
 Git commit:   60ccb22
 Built:        Thu Feb 23 11:02:43 2017
 OS/Arch:      linux/amd64

Server:
 Version:      17.03.0-ce
 API version:  1.26 (minimum version 1.12)
 Go version:   go1.7.5
 Git commit:   60ccb22
 Built:        Thu Feb 23 11:02:43 2017
 OS/Arch:      linux/amd64
 Experimental: false
</code></pre>

<p>В примере рассмотрим сборку docker-образа для контейнера с Nginx (как полагается, с <a href="https://letsclearitup.com.ua/debian/peresborka-nginx-s-podderzhkoy-brotli.html">поддержкой Brotli</a> и свеженьким <a href="https://letsclearitup.com.ua/debian/peresborka-nginx-s-openssl-1-0-2-dlya-http2-0.html">OpenSSL для HTTP2.0</a>). Кроме этого, при запуске контейнера из шаблонов будут генерироваться конфигурационные файлы сайтов (в зависимости от параметров из <code>.env</code>-файла).</p>

<p>Dockerfile (инструкции по сборке образа) выглядит так:</p>

<pre><code>FROM debian:jessie
 
ENV NGINX_VERSION=1.11.10
ENV OPENSSL_VERSION=1.0.2g
ENV NGX_CACHE_PURGE_VERSION=2.3
 
RUN apt-get update \
    &amp;&amp; apt-get install -y \
    build-essential \
    automake \
    autoconf \
    libtool \
    openssl \
    zlib1g-dev \
    libpcre3 \
    libpcre3-dev \
    libgeoip-dev \
    unzip \
    wget \
    git \
    curl
 
RUN cd /tmp \
    &amp;&amp; git clone https://github.com/bagder/libbrotli \
    &amp;&amp; cd libbrotli \
    &amp;&amp; ./autogen.sh \
    &amp;&amp; ./configure \
    &amp;&amp; make &amp;&amp; make install \
    &amp;&amp; cd /tmp \
    &amp;&amp; git clone https://github.com/google/ngx_brotli \
    &amp;&amp; wget -qO - https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz \
       | tar xzf  - -C /tmp \
    &amp;&amp; wget http://labs.frickle.com/files/ngx_cache_purge-$NGX_CACHE_PURGE_VERSION.tar.gz \
    &amp;&amp; tar -zxvf ngx_cache_purge-$NGX_CACHE_PURGE_VERSION.tar.gz &amp;&amp; mv ngx_cache_purge-$NGX_CACHE_PURGE_VERSION ngx_cache_purge &amp;&amp; rm ngx_cache_purge-$NGX_CACHE_PURGE_VERSION.tar.gz \
    &amp;&amp; wget https://github.com/openresty/echo-nginx-module/archive/v0.60.tar.gz \
    &amp;&amp; tar -zxvf v0.60.tar.gz &amp;&amp; rm v0.60.tar.gz \
    &amp;&amp; mkdir -p /var/cache/nginx/client_temp \
    &amp;&amp; wget http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz \
    &amp;&amp; tar -xvzf nginx-${NGINX_VERSION}.tar.gz \
    &amp;&amp; cd /tmp/ngx_brotli &amp;&amp; git submodule update --init \
    &amp;&amp; cd /tmp/nginx-${NGINX_VERSION} \
    &amp;&amp; ./configure \
        --prefix=/opt/nginx \
        --sbin-path=/usr/sbin/nginx \
    --modules-path=/usr/lib64/nginx/modules \
        --conf-path=/opt/nginx/nginx.conf \
    --error-log-path=/var/log/nginx/error.log \
    --http-log-path=/var/log/nginx/access.log \
        --pid-path=/var/run/nginx.pid \
        --lock-path=/var/run/nginx.lock \
    --http-client-body-temp-path=/var/cache/nginx/client_temp \
    --http-proxy-temp-path=/var/cache/nginx/proxy_temp \
    --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \
    --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \
    --http-scgi-temp-path=/var/cache/nginx/scgi_temp \
        --user=www-data \
        --group=www-data \
        --with-http_stub_status_module \
        --with-http_geoip_module \
        --with-http_ssl_module \
        --with-http_realip_module \
        --with-http_addition_module \
        --with-http_sub_module \
        --with-http_dav_module \
        --with-http_gunzip_module \
        --with-http_gzip_static_module \
        --with-http_random_index_module \
        --with-http_secure_link_module \
        --with-http_auth_request_module \
        --without-http_ssi_module \
 
        --with-threads \
        --with-stream \
        --with-stream_ssl_module \
        --with-file-aio \
        --with-http_v2_module \
        --with-ipv6 \
        --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic' \
 
        --with-openssl=/tmp/openssl-${OPENSSL_VERSION} \
        --add-module=/tmp/ngx_brotli \
    --add-module=/tmp/ngx_cache_purge \
    --add-module=/tmp/echo-nginx-module-0.60 \
    &amp;&amp; make \
    &amp;&amp; make install
 
RUN apt-get remove -y build-essential zlib1g-dev libpcre3-dev unzip \
    &amp;&amp; apt-get autoremove -y \
    &amp;&amp; apt-get clean \
    &amp;&amp; rm -rf /tmp/nginx-${NGINX_VERSION}* \
    &amp;&amp; rm -rf /tmp/ngx_brotli \
    &amp;&amp; rm -rf /tmp/ngx_cache_purge \
    &amp;&amp; rm -rf /tmp/libbrotli \
    &amp;&amp; rm -rf /tmp/openssl-1.0.2g \
    &amp;&amp; rm -rf /tmp/echo-nginx-module-0.60
 
ENV DOCKERIZE_VERSION v0.3.0
RUN wget https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz \
    &amp;&amp; tar -C /usr/local/bin -xzvf dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz \
    &amp;&amp; rm dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz
 
RUN ln -sf /dev/stdout /var/log/nginx/access.log \
    &amp;&amp; ln -sf /dev/stderr /var/log/nginx/error.log
 
ADD . /opt/nginx/
ARG PUID=1000
RUN usermod -u ${PUID} www-data
EXPOSE 80 443
CMD dockerize -template /opt/nginx/conf.d/main.tmpl:/opt/nginx/conf.d/main-gen.conf -template /opt/nginx/conf.d/landing.tmpl:/opt/nginx/conf.d/landing-gen.conf nginx
</code></pre>

<p>Для сборки образа, находясь в каталоге с Dockerfile, запускаем команду:</p>

<pre><code>docker build -t nginx-test:latest .
</code></pre>

<p>Проверим наличие нового образа после сборки:</p>

<pre><code>docker images nginx-test 
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
nginx-test          latest              43bf91aeb416        3 minutes ago       732 MB
</code></pre>

<p>Размер образа составляет целых 732 MB! Размер, конечно, не столь важен, если мы говорим про образы использующиеся только на локальной машине. Но это становится проблемой, когда нужно постоянно скачивать/отправлять эти образы через интернет.</p>

<p>Для оптимизации docker-образов можно воспользоваться утилитой <a href="https://github.com/goldmann/docker-squash"><code>docker-squash</code></a>. Установить ее довольно просто:</p>

<pre><code>pip install docker-squash
</code></pre>

<p>Данная утилита позволяет объединять слои docker-образов (не забываем о том, что каждая инструкция в Dockerfile создает новый слой, и в нашем образе содержится аж 16 слоев). Слои можно объединять частично (например, N последних или с X по Y) или полностью (как мы и поступим).</p>

<p>Запускаем команду:</p>

<pre><code>docker-squash -t nginx-test:squashed nginx-test:latest
2017-03-20 13:42:39,562 root         INFO     docker-squash version 1.0.5, Docker 60ccb22, API 1.26...
2017-03-20 13:42:39,562 root         INFO     Using v2 image format
2017-03-20 13:42:39,582 root         INFO     Old image has 16 layers
2017-03-20 13:42:39,582 root         INFO     Checking if squashing is necessary...
2017-03-20 13:42:39,582 root         INFO     Attempting to squash last 16 layers...
2017-03-20 13:42:39,582 root         INFO     Saving image sha256:43bf91aeb416da42a75d2a0b825567aaed9742200a081259c85fa2d10e96f2ed to /tmp/docker-squash-sUSIVv/old directory...
2017-03-20 13:43:08,947 root         INFO     Image saved!
2017-03-20 13:43:08,947 root         INFO     Squashing image 'nginx-test:latest'...
2017-03-20 13:43:09,848 root         INFO     Starting squashing...
2017-03-20 13:43:09,849 root         INFO     Squashing file '/tmp/docker-squash-sUSIVv/old/e0d4b8ce48d8fd1930b367ed7aff1f7795b74756ed4ed9062acd18e59f6bdf06/layer.tar'...
2017-03-20 13:43:09,871 root         INFO     Squashing file '/tmp/docker-squash-sUSIVv/old/36675d6554a8ebdf72265fe739214048565925b04a739733b84caddb92702b02/layer.tar'...
2017-03-20 13:43:10,189 root         INFO     Squashing file '/tmp/docker-squash-sUSIVv/old/968002289f33e062ba172190dadeb0046ec6d34407992cbf1ca239d93d23e684/layer.tar'...
2017-03-20 13:43:10,191 root         INFO     Squashing file '/tmp/docker-squash-sUSIVv/old/23bc9170b2cb9a7aee432d93d651288fa506178be14fbadfb630bcda09977ad3/layer.tar'...
2017-03-20 13:43:10,345 root         INFO     Squashing file '/tmp/docker-squash-sUSIVv/old/1d8ab492b6fbfd6d2c00c43cccac25053b2669f590261c58a071204977426dcd/layer.tar'...
2017-03-20 13:43:11,172 root         INFO     Squashing file '/tmp/docker-squash-sUSIVv/old/dcda4589a5d2be254d81216d1b22a26e633d8cc36ed3f1a27117f1ce4e852baf/layer.tar'...
2017-03-20 13:43:11,945 root         INFO     Squashing file '/tmp/docker-squash-sUSIVv/old/d904382d2c552061a5a4198a9e0dcb56fb8515eb0bdc17969b28b366edb8dfb6/layer.tar'...
2017-03-20 13:43:20,774 root         INFO     Squashing file '/tmp/docker-squash-sUSIVv/old/c22ce97cf003214a558f7a68d9a0538e504321bae40a8fe6aad393bf5be114bc/layer.tar'...
2017-03-20 13:43:36,312 root         INFO     Squashing finished!
2017-03-20 13:43:37,681 root         INFO     New squashed image ID is 3c1cfae6f24c14d4417aa6e32bc96d41e2e2caf8fbd0a351b027e2619fc493b1
2017-03-20 13:43:45,236 root         INFO     Image registered in Docker daemon as nginx-test:squashed
2017-03-20 13:43:45,297 root         INFO     Done
</code></pre>

<p>Проверим информацию о docker-образах с именем nginx-test (теперь их станет 2):</p>

<pre><code>docker images nginx-test 
REPOSITORY          TAG                 IMAGE ID            CREATED              SIZE
nginx-test          squashed            3c1cfae6f24c        About a minute ago   399 MB
nginx-test          latest              43bf91aeb416        9 minutes ago        732 MB
</code></pre>

<p>Как видим, последний образ с тегом <code>squashed</code> уменьшился на 46%.</p>

<p>Следует отметить, что docker-engine начиная с версии 1.13 в <strong>экспериментальном режиме</strong> содержит возможность сборки уже сжатых образов. Для этого в команду сборки необходимо добавить параметр <code>--squash</code>, например:</p>

<pre><code>docker build --squash -t nginx-test:late .
Error response from daemon: squash is only supported with experimental mode
</code></pre>

<p>Чтобы <strong>включить експериментальный режим docker-engine в Ubuntu 16.04</strong> необходимо в конфигурационном файле <code>/lib/systemd/system/docker.service</code> добавить параметр <code>--experimental=true</code>.</p>

<p>В моем случае это выглядит так:</p>

<pre><code>[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network.target docker.socket firewalld.service
Requires=docker.socket
 
[Service]
Type=notify
# the default is not to use systemd for cgroups because the delegate issues still
# exists and systemd currently does not support the cgroup feature set required
# for containers run by docker
ExecStart=/usr/bin/dockerd -H fd:// --experimental=true
ExecReload=/bin/kill -s HUP $MAINPID
LimitNOFILE=1048576
# Having non-zero Limit*s causes performance problems due to accounting overhead
# in the kernel. We recommend using cgroups to do container-local accounting.
LimitNPROC=infinity
LimitCORE=infinity
# Uncomment TasksMax if your systemd version supports it.
# Only systemd 226 and above support this version.
TasksMax=infinity
TimeoutStartSec=0
# set delegate yes so that systemd does not reset the cgroups of docker containers
Delegate=yes
# kill only the docker process, not all processes in the cgroup
KillMode=process
 
[Install]
WantedBy=multi-user.target
</code></pre>

<p>После изменения конфигурационного файла выполняем:</p>

<pre><code>sudo systemctl daemon-reload
</code></pre>

<pre><code>sudo systemctl restart docker
</code></pre>

<p>Проверим информацию о версии docker-engine (следует обратить внимание на последнюю строку):</p>

<pre><code>docker version
Client:
 Version:      17.03.0-ce
 API version:  1.26
 Go version:   go1.7.5
 Git commit:   60ccb22
 Built:        Thu Feb 23 11:02:43 2017
 OS/Arch:      linux/amd64

Server:
 Version:      17.03.0-ce
 API version:  1.26 (minimum version 1.12)
 Go version:   go1.7.5
 Git commit:   60ccb22
 Built:        Thu Feb 23 11:02:43 2017
 OS/Arch:      linux/amd64
 Experimental: true
</code></pre>

<p>Теперь можно сразу собирать сжатые docker-образы командой:</p>

<pre><code>docker build --squash -t nginx-test:late .
</code></pre>
                </section>
            </article>

            
                <a class="twitter" href="https://twitter.com/intent/tweet?text=https%3a%2f%2fealebed.github.io%2fposts%2f%25D0%25BE%25D0%25BF%25D1%2582%25D0%25B8%25D0%25BC%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F-docker-%25D0%25BE%25D0%25B1%25D1%2580%25D0%25B0%25D0%25B7%25D0%25BE%25D0%25B2%2f - %d0%9e%d0%bf%d1%82%d0%b8%d0%bc%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d1%8f%20docker-%d0%be%d0%b1%d1%80%d0%b0%d0%b7%d0%be%d0%b2 by @ealebed"><span class="icon-twitter"> tweet</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

            

            
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ealebed'; 

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

            

            
                <ul id="post-list" class="archive readmore">
    <h3>Read more</h3>

    
    
    
        <li>
            <a href="/posts/jenkins-as-a-code-%D1%87%D0%B0%D1%81%D1%82%D1%8C-1/">Jenkins as a code. Часть 1<aside class="dates">Aug 6 2018</aside></a>
        </li>
    
        <li>
            <a href="/posts/docker-%D1%81%D0%BE%D0%B2%D0%B5%D1%82-33-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B4%D0%B2%D1%83%D1%85-dockerfile-%D0%B2-%D0%BE%D0%B4%D0%BD%D0%BE%D0%BC-compose-%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B5/">Docker совет №33: Использование двух Dockerfile в одном compose-проекте<aside class="dates">Aug 2 2018</aside></a>
        </li>
    
        <li>
            <a href="/posts/jenkins-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-shared-libraries/">Jenkins: использование shared libraries<aside class="dates">Jul 30 2018</aside></a>
        </li>
    
        <li>
            <a href="/posts/docker-%D1%81%D0%BE%D0%B2%D0%B5%D1%82-32-%D1%80%D0%B0%D0%B7%D0%BD%D0%B8%D1%86%D0%B0-%D0%BC%D0%B5%D0%B6%D0%B4%D1%83-create-start-%D0%B8-run/">Docker совет №32: Разница между create, start и run<aside class="dates">Jul 26 2018</aside></a>
        </li>
    
        <li>
            <a href="/posts/%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA-docker-compose-%D1%81-%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E-systemd-unit/">Запуск docker-compose с помощью systemd unit<aside class="dates">Jul 23 2018</aside></a>
        </li>
    
</ul>

            

            <footer id="footer">
    
        <div id="social">
	
	
    <a class="symbol" href="https://www.facebook.com/ealebed">
        <i class="fa fa-facebook-square"></i>
    </a>
    
    <a class="symbol" href="https://www.github.com/ealebed">
        <i class="fa fa-github-square"></i>
    </a>
    
    <a class="symbol" href="https://www.twitter.com/ealebed">
        <i class="fa fa-twitter-square"></i>
    </a>
    

</div>

    
    <p class="small">
    
       © Copyright 2018 <i class="fa fa-heart" aria-hidden="true"></i> Evgen Lebed
    
    </p>
</footer>

        </section>

        <script src="https://ealebed.github.io/js/jquery-2.2.4.min.js"></script>
<script src="https://ealebed.github.io/js/main.js"></script>
<script src="https://ealebed.github.io/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




  
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-112453311-1', 'auto');
ga('send', 'pageview');
</script>



    </body>
</html>
