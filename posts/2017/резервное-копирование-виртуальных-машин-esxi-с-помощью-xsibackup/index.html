<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		 
			
  
    <meta name="twitter:card" content="summary"/>
    
      <meta name="twitter:image" content="https://ealebed.github.io/images/avatar.png" />
    
  
  
  <meta name="twitter:title" content="Резервное копирование виртуальных машин ESXI с помощью Xsibackup"/>
  <meta name="twitter:description" content="Возможности резервного копирования виртуальных машин на гипервизоре под управлением ESXI с бесплатной лицензией существенно ограничены — например, тут не получится использовать vCenter, а функциональность бесплатных версий Veeam Backup или VM Explorer значительно урезана.

"/>
  
    <meta name="twitter:site" content="@ealebed"/>
  
  
  
  
    <meta name="twitter:creator" content="@Yevhen Lebid"/>
  



		
		<meta name="author" content="Yevhen Lebid">
		<meta name="description" content="Yevhen Lebid&#39;s website">
		<meta name="generator" content="Hugo 0.38.2" />
		<title>Резервное копирование виртуальных машин ESXI с помощью Xsibackup &middot; Yevhen Lebid&#39;s website</title>
		<link rel="shortcut icon" href="https://ealebed.github.io/images/favicon.ico">
		<link rel="stylesheet" href="https://ealebed.github.io/css/style.css">
		<link rel="stylesheet" href="https://ealebed.github.io/css/highlight.css">

		<link rel="stylesheet" href="https://ealebed.github.io/css/font-awesome.min.css">

		
	</head>

    <body>
       <nav class="main-nav">
	
	
		<a href='https://ealebed.github.io/'> <span class="arrow">←</span>Home</a>
	
	<a href='https://ealebed.github.io/posts'>Archive</a>
	<a href='https://ealebed.github.io/tags'>Tags</a>
	<a href='https://ealebed.github.io/about'>About</a>

	
</nav>


        <section id="wrapper" class="post">
            <article>
                <header>
                    <h1>
                        Резервное копирование виртуальных машин ESXI с помощью Xsibackup
                    </h1>
                    <h2 class="headline">
                    Apr 3, 2017 13:56
                    · 868 words
                    · 5 minute read
                      <span class="tags">
                      
                      
                          
                              <a href="https://ealebed.github.io/tags/esxi">esxi</a>
                          
                              <a href="https://ealebed.github.io/tags/backup">backup</a>
                          
                      
                      
                      </span>
                    </h2>
                </header>
                <section id="post-body">
                    <p>Возможности резервного копирования виртуальных машин на гипервизоре под управлением ESXI с бесплатной лицензией существенно ограничены — например, тут не получится использовать vCenter, а функциональность бесплатных версий Veeam Backup или VM Explorer значительно урезана.</p>

<p></p>

<p>Порой проще «закрыть глаза» на все эти условности с лицензиями, но гораздо чаще приходится осваивать малоизвестные бесплатные решения или придумывать собственные костыли и велосипеды. Давайте разберемся с <strong>резервным копированием виртуальных машин ESXI с помощью Xsibackup</strong>!</p>

<p>Итак, основными возможностями бесплатной версии Xsibackup являются:</p>

<ul>
<li>«горячие» бэкапы без остановки виртуальных машин. Делаются с помощью снепшота (<code>snapshot</code>);</li>
<li>настройка крона (<code>cron</code>) в ESXI для бекапов по расписанию;</li>
<li>результаты выполнения заданий можно получать на email;</li>
<li>ротация бэкапов (удаление самых старых при заполнении отведенного дискового пространства);</li>
<li>резервное копирование виртуальных машин на другой ESXI хост (в бесплатной версии — с помощью <code>rsync</code>).</li>
</ul>

<p>Переходим по <a href="https://33hops.com/xsibackup-vmware-esxi-backup.html">ссылке</a> для скачивания утилиты Xsibackup, вводим личные данные и обязательно работающий email — на него придет специальный <code>SecretKey</code> и скрипт для установки.</p>

<p>Все команды необходимо вводить на хосте под управлением ESXI, на котором будут делаться бэкапы.</p>

<p><strong>Примечание.</strong> На ESXI должна быть включена служба SSH.</p>

<p>Подключаемся к консоли ESXI по ssh и вводим команды из письма для установки Xsibackup (повторяем данную процедуру на всех гипервизорах):</p>

<pre><code class="language-bash">cd /vmfs/volumes/datastore1/xsi-dir 2&gt;/dev/null || mkdir /vmfs/volumes/datastore1/xsi-dir &amp;&amp; \
&gt; cd /vmfs/volumes/datastore1/xsi-dir &amp;&amp; \
&gt; esxcli network firewall unload &amp;&amp; \
&gt; wget http://a.33hops.com/downloads/?key= -O xsibackup.zip &amp;&amp; \
&gt; unzip -o xsibackup.zip || cat xsibackup.zip &amp;&amp; echo &quot;&quot; &amp;&amp; \
&gt; chmod -R 0700 xsibackup* bin &amp;&amp; \
&gt; rm -rf xsibackup.zip &amp;&amp; \
&gt; esxcli network firewall load
Connecting to a.33hops.com (188.165.2.135:80)
xsibackup.zip        100% |*************************************************************************************************|   546k  0:00:00 ETA
Archive:  xsibackup.zip
   creating: src/
  inflating: src/borg
  inflating: src/custimg
  inflating: src/esxbackup
  inflating: src/events
  inflating: src/onediff
  inflating: src/restore
  inflating: src/smartinfo
  inflating: src/xsitools
  inflating: EULA
  inflating: README.txt
  inflating: xsibackup
   creating: bin/
  inflating: bin/xsibackup-rsync
</code></pre>

<p>Создаем каталог для хранения резервных копий:</p>

<pre><code class="language-bash">mkdir /vmfs/volumes/datastore2/backup
</code></pre>

<p>Проверим возможность создания бекапов локально:</p>

<pre><code class="language-bash">./xsibackup --backup-point=/vmfs/volumes/datastore2/backup --backup-type=running --test-mode=true

#####################################################################################
#                                                                                   #
#  (c) XSIBACKUP-FREE 9.0.1 | Backup for (c) VMWARE ESXi Hypervisor by 33hops.com   #
#                                                                                   #
#####################################################################################

XSIBackup PID: 76601024                                            99.your-server.de
Sat, 04 Mar 2017 17:30:34 +0000                 IPv4: 31.42.119.138/255.255.255.224
VMware ESXi 5.5.0 build-3568722                   (c) Rsync 3.1.0 as opt. dependency

---------------------------------------------------------------------------------------------------------
Found --backup-point at [ /vmfs/volumes/datastore2/backup ]
---------------------------------------------------------------------------------------------------------
Getting list of all VMs...
---------------------------------------------------------------------------------------------------------
1      db1       [datastore1] db1/db1.vmx           otherLinux64Guest   vmx-08
2      web1      [datastore2] web1/web1.vmx         otherLinux64Guest   vmx-08
3      mercury   [datastore1] mercury/mercury.vmx   otherLinux64Guest   vmx-08
---------------------------------------------------------------------------------------------------------
VMs to backup:
---------------------------------------------------------------------------------------------------------
1      db1       [datastore1] db1/db1.vmx           otherLinux64Guest   vmx-08
2      web1      [datastore2] web1/web1.vmx         otherLinux64Guest   vmx-08
3      mercury   [datastore1] mercury/mercury.vmx   otherLinux64Guest   vmx-08
---------------------------------------------------------------------------------------------------------
Needed room: 81 Gb.
Available room: 1823 Gb.
---------------------------------------------------------------------------------------------------------
Excerpt
---------------------------------------------------------------------------------------------------------
Hot backup selected for VM: [db1], will not be switched off
---------------------------------------------------------------------------------------------------------
Test mode activated VMs will not be cloned, please remove --test-mode=true to allow backups
Excerpt
---------------------------------------------------------------------------------------------------------
Hot backup selected for VM: [web1], will not be switched off
---------------------------------------------------------------------------------------------------------
Test mode activated VMs will not be cloned, please remove --test-mode=true to allow backups
Excerpt
---------------------------------------------------------------------------------------------------------
Hot backup selected for VM: [mercury], will not be switched off
---------------------------------------------------------------------------------------------------------
Test mode activated VMs will not be cloned, please remove --test-mode=true to allow backups
---------------------------------------------------------------------------------------------------------
No errors detected in backup
---------------------------------------------------------------------------------------------------------
Backup finished
Tip: no chained backups scheduled, set --on-success and/or --on-error arguments to chain a backup
Killed
</code></pre>

<p>Тест успешен, для того чтобы сделать резервную копию всех запущенных виртуальных машин запускаем команду еще раз, но без опции <code>--test-mode=true</code>:</p>

<pre><code class="language-bash">./xsibackup --backup-point=/vmfs/volumes/datastore2/backup --backup-type=running
</code></pre>

<p>Если же необходимо сделать бекап только одной виртуальной машины, то команда будет выглядеть так:</p>

<pre><code class="language-bash">./xsibackup --backup-point=/vmfs/volumes/datastore2/backup --backup-type=custom --backup-vms=web1
</code></pre>

<p>Если планируем хранить резервные копии на другом хосте ESXI (или переносить виртуальные машины), то хосты необходимо «связать». Для этого нужно убедиться, что на гипервизоре в настройках файрвола включено правило «SSH Client» (открывает 22 порт для исходящих соединений), после чего в консоли выполнить:</p>

<pre><code class="language-bash">./xsibackup --link-srv=31.42.119.138

#####################################################################################
#                                                                                   #
#  (c) XSIBACKUP-FREE 9.0.1 | Backup for (c) VMWARE ESXi Hypervisor by 33hops.com   #
#                                                                                   #
#####################################################################################

XSIBackup PID: 8542898                                           100.your-server.de
No RSA public key found, we will generate one...
The RSA key has been generated.
Enter the remote server root password when prompted.
The authenticity of host '31.42.119.138 (31.42.119.138)' can't be established.
RSA key fingerprint is SHA256:EH2yP2n6LTC63GfU9QewzEP9N8Gfhhoq2e7SRQpR8f8.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '31.42.119.138' (RSA) to the list of known hosts.
Password:
Password:
The RSA key has been added to the authorized_keys file at 31.42.119.138.
Rebooting local SSH service...
SSH login disabled
SSH login enabled
Rebooting remote SSH service...
SSH login disabled
SSH login enabled
Killed
</code></pre>

<p>Теперь можно выполнять резервное копирование виртуальных машин на удаленный хост, для этого используем следующую команду:</p>

<pre><code class="language-bash">./xsibackup --backup-point=31.42.119.138:22:/vmfs/volumes/datastore2/backup --backup-type=running
</code></pre>

<p>Для настройки крона сначала нужно его установить командой:</p>

<pre><code class="language-bash">./xsibackup --install-cron

#####################################################################################
#                                                                                   #
#  (c) XSIBACKUP-FREE 9.0.1 | Backup for (c) VMWARE ESXi Hypervisor by 33hops.com   #
#                                                                                   #
#####################################################################################

XSIBackup PID: 8544019                                           100.your-server.de
This command will install XSIBackup cron to your ESXi &gt; 5.1 BOX
xsibackup-cron will be installed to the current working directory
You should cd to the desired directory before installing the cron
Do you wish to continue? (y/n) y
Removing cron info...
Adding new cron info...
The local cron service will be restarted
You might need to reboot the ESXi server for the changes to take effect...
cron service restarted
</code></pre>

<p>Подробнейшая инструкция по настройке периодичного резервного копирования находится <a href="https://33hops.com/xsibackup-cron-how-to.html">тут</a>, а полный список доступных опций и примеры их использования можно посмотреть <a href="https://33hops.com/xsibackup-help-man-page.html">здесь</a>.</p>
                </section>
            </article>

            
                <a class="twitter" href="https://twitter.com/intent/tweet?text=https%3a%2f%2fealebed.github.io%2fposts%2f2017%2f%25D1%2580%25D0%25B5%25D0%25B7%25D0%25B5%25D1%2580%25D0%25B2%25D0%25BD%25D0%25BE%25D0%25B5-%25D0%25BA%25D0%25BE%25D0%25BF%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5-%25D0%25B2%25D0%25B8%25D1%2580%25D1%2582%25D1%2583%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D1%2585-%25D0%25BC%25D0%25B0%25D1%2588%25D0%25B8%25D0%25BD-esxi-%25D1%2581-%25D0%25BF%25D0%25BE%25D0%25BC%25D0%25BE%25D1%2589%25D1%258C%25D1%258E-xsibackup%2f - %d0%a0%d0%b5%d0%b7%d0%b5%d1%80%d0%b2%d0%bd%d0%be%d0%b5%20%d0%ba%d0%be%d0%bf%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5%20%d0%b2%d0%b8%d1%80%d1%82%d1%83%d0%b0%d0%bb%d1%8c%d0%bd%d1%8b%d1%85%20%d0%bc%d0%b0%d1%88%d0%b8%d0%bd%20ESXI%20%d1%81%20%d0%bf%d0%be%d0%bc%d0%be%d1%89%d1%8c%d1%8e%20Xsibackup by @ealebed"><span class="icon-twitter"> tweet</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

            

            
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ealebed'; 

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

            

            
                <ul id="post-list" class="archive readmore">
    <h3>Read more</h3>

    
    
    
        <li>
            <a href="/posts/2019/deploy-to-kubernetes-with-spinnaker-part-1-setup/">Deploy to k8s with Spinnaker. Часть 1: Установка<aside class="dates">Jan 24 2019</aside></a>
        </li>
    
        <li>
            <a href="/posts/2019/gradle-checkstyle-plugin/">Gradle Checkstyle plugin<aside class="dates">Jan 8 2019</aside></a>
        </li>
    
        <li>
            <a href="/posts/2019/%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%BE%D0%B2-%D1%81-%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E-gradle/">Сборка проектов с помощью Gradle<aside class="dates">Jan 3 2019</aside></a>
        </li>
    
        <li>
            <a href="/posts/2018/grpc-rest-gateway/">GRPC REST Gateway<aside class="dates">Dec 29 2018</aside></a>
        </li>
    
        <li>
            <a href="/posts/2018/%D0%BF%D1%80%D0%B0%D0%BA%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5-%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D1%8B-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-tcpdump/">Практические примеры использования tcpdump<aside class="dates">Oct 18 2018</aside></a>
        </li>
    
</ul>

            

            <footer id="footer">
    
        <div id="social">
	
	
    <a class="symbol" href="https://www.facebook.com/ealebed">
        <i class="fa fa-facebook-square"></i>
    </a>
    
    <a class="symbol" href="https://www.github.com/ealebed">
        <i class="fa fa-github-square"></i>
    </a>
    
    <a class="symbol" href="https://www.twitter.com/ealebed">
        <i class="fa fa-twitter-square"></i>
    </a>
    

</div>

    
    <p class="small">
    
       © Copyright 2019 <i class="fa fa-heart" aria-hidden="true"></i> Yevhen Lebid
    
    </p>
</footer>

        </section>

        <script src="https://ealebed.github.io/js/jquery-2.2.4.min.js"></script>
<script src="https://ealebed.github.io/js/main.js"></script>
<script src="https://ealebed.github.io/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




  
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-112453311-1', 'auto');
ga('send', 'pageview');
</script>



    </body>
</html>
