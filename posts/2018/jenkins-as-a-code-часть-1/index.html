<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		 
			
  
    <meta name="twitter:card" content="summary"/>
    
      <meta name="twitter:image" content="https://ealebed.github.io/images/avatar.png" />
    
  
  
  <meta name="twitter:title" content="Jenkins as a code. Часть 1"/>
  <meta name="twitter:description" content="Идея &ldquo;инфраструктура как код&rdquo; далеко не нова и широко используется в повседневной жизни большинством компаний. В серии статей &ldquo;Jenkins as a code&rdquo; предлагаю разобраться с автоматическим развертыванием и настройкой сервера Jenkins!"/>
  
    <meta name="twitter:site" content="@ealebed"/>
  
  
  
  
    <meta name="twitter:creator" content="@Yevhen Lebid"/>
  



		
		<meta name="author" content="Yevhen Lebid">
		<meta name="description" content="Yevhen Lebid&#39;s website">
		<meta name="generator" content="Hugo 0.87.0" />
		
  			
			<script async src="https://www.googletagmanager.com/gtag/js?id=UA-112453311-1"></script>
			<script>
			  window.dataLayer = window.dataLayer || [];
			  function gtag(){dataLayer.push(arguments);}
			  gtag('js', new Date());

			  gtag('config', 'UA-112453311-1');
			</script>
		
		<title>Jenkins as a code. Часть 1 &middot; Yevhen Lebid&#39;s website</title>
		<link rel="shortcut icon" href="https://ealebed.github.io/images/favicon.ico">
		<link rel="stylesheet" href="https://ealebed.github.io/css/style.css">
		<link rel="stylesheet" href="https://ealebed.github.io/css/highlight.css">

		
		<link rel="stylesheet" href="https://ealebed.github.io/css/font-awesome.min.css">
		

		
		<link href="https://ealebed.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Yevhen Lebid&#39;s website" />
		


		
	</head>

    <body>
       <nav class="main-nav">
	
	
		<a href='https://ealebed.github.io/'> <span class="arrow">←</span>Home</a>
	
	<a href='https://ealebed.github.io/posts'>Archive</a>
	<a href='https://ealebed.github.io/tags'>Tags</a>
	<a href='https://ealebed.github.io/about'>About</a>

	

	
		<a class="cta" href="https://ealebed.github.io/index.xml">RSS</a>
	
</nav>


        <section id="wrapper" class="post">
            <article>
                <header>
                    <h1>
                        Jenkins as a code. Часть 1
                    </h1>
                    <h2 class="headline">
                    Aug 6, 2018 07:08
                    · 747 words
                    · 4 minute read
                      <span class="tags">
                      
                      
                          
                              <a href="https://ealebed.github.io/tags/jenkins">jenkins</a>
                          
                              <a href="https://ealebed.github.io/tags/ci">CI</a>
                          
                              <a href="https://ealebed.github.io/tags/scripts">scripts</a>
                          
                      
                      
                      </span>
                    </h2>
                </header>
                <section id="post-body">
                    <p>Идея &ldquo;инфраструктура как код&rdquo; далеко не нова и широко используется в повседневной жизни большинством компаний. В серии статей &ldquo;Jenkins as a code&rdquo; предлагаю разобраться с автоматическим развертыванием и настройкой сервера Jenkins!</p>
<p>Казалось бы, зачем эти статьи, если можно взять готовую <a href="https://galaxy.ansible.com/geerlingguy/jenkins/">роль jenkins</a> для системы управления конфигурациями Ansible или <a href="https://supermarket.chef.io/cookbooks/jenkins">кукбук jenkins</a> для chef, или даже воспользоваться готовым <a href="https://hub.docker.com/r/jenkins/jenkins/">docker-образом</a>?</p>
<p>Развертывание базовой конфигурации - это действительно несложный процесс (мы его рассматривать не будем, тут каждый волен выбирать свои инструменты), поэтому остановимся подробнее именно на настройке Jenkins под собственные нужды (данная статья), автоматической настройке общих библиотек (вторая часть) и импорте задач (третья часть).</p>
<p>Для кастомизации и тонкой настройки вашего экземпляра Jenkins разработчики предлагают использовать хуков (groovy-скриптов), которые нужно размещать в каталоге <code>${JENKINS_HOME}/init.groovy.d/</code>.</p>
<p>В зависимости от выбранного инструмента развертывания, способ, которым скрипты попадут в нужный каталог будет отличаться. Например, при использовании docker-образа, самым простым будет поместить нужные скрипты в каталог <code>/usr/share/jenkins/ref/init.groovy.d/</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> jenkins/jenkins:lts</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> custom.groovy /usr/share/jenkins/ref/init.groovy.d/custom.groovy<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>При старте docker-контейнера все, что находится в каталоге <code>/usr/share/jenkins/ref/</code> копируется в каталог <code>${JENKINS_HOME}</code> (следовательно, каталог <code>init.groovy.d</code> со всем содержимым будет скопирован в нужное место).</p>
<p>Стоит отметить, что скрипты из каталоге <code>${JENKINS_HOME}/init.groovy.d/</code> запускаются при старте Jenkins и выполняются в алфавитном порядке - это очень важный момент, если нужно соблюдать последовательность запуска.</p>
<p>Чаще всего с помощью хуков в Jenkins устанавливают плагины, выполняют глобальную настройку, включают/выключают опции безопасности, добавляют ключи доступа к системе хранения версиями.</p>
<p>В моем случае для тонкой настройки экземпляра Jenkins используется несколько скриптов. Для соблюдения порядка запуска в начале имени каждого скрипта присутствуют цифры.</p>
<p>Скрипт <code>00-install-plugins.groovy</code> выполняет установку необходимых плагинов с зависимостями и выглядит следующим образом:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/*
</span><span style="color:#75715e">    Install required plugins and their dependencies.
</span><span style="color:#75715e">*/</span>
<span style="color:#f92672">import</span> jenkins.model.*
<span style="color:#f92672">import</span> hudson.model.*
<span style="color:#f92672">import</span> org.jenkinsci.plugins.*
<span style="color:#f92672">import</span> hudson.model.UpdateSite
<span style="color:#f92672">import</span> hudson.PluginWrapper

Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> plugins_to_install <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>
    <span style="color:#e6db74">&#34;github-pullrequest&#34;</span><span style="color:#f92672">,</span>
    <span style="color:#e6db74">&#34;google-login&#34;</span><span style="color:#f92672">,</span>
    <span style="color:#e6db74">&#34;workflow-aggregator&#34;</span><span style="color:#f92672">,</span>
    <span style="color:#e6db74">&#34;htmlpublisher&#34;</span><span style="color:#f92672">,</span>
    <span style="color:#e6db74">&#34;locale&#34;</span>
<span style="color:#f92672">]</span>

Boolean hasConfigBeenUpdated <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
UpdateSite updateSite <span style="color:#f92672">=</span> Jenkins<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getUpdateCenter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getById</span><span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#66d9ef">default</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">)</span>
List<span style="color:#f92672">&lt;</span>PluginWrapper<span style="color:#f92672">&gt;</span> plugins <span style="color:#f92672">=</span> Jenkins<span style="color:#f92672">.</span><span style="color:#a6e22e">instance</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pluginManager</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPlugins</span><span style="color:#f92672">()</span>

def <span style="color:#a6e22e">install_plugin</span><span style="color:#f92672">(</span>shortName<span style="color:#f92672">,</span> UpdateSite updateSite<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    println <span style="color:#e6db74">&#34;Installing ${shortName} plugin.&#34;</span>
    UpdateSite<span style="color:#f92672">.</span><span style="color:#a6e22e">Plugin</span> plugin <span style="color:#f92672">=</span> updateSite<span style="color:#f92672">.</span><span style="color:#a6e22e">getPlugin</span><span style="color:#f92672">(</span>shortName<span style="color:#f92672">)</span>
    Throwable error <span style="color:#f92672">=</span> plugin<span style="color:#f92672">.</span><span style="color:#a6e22e">deploy</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getError</span><span style="color:#f92672">()</span>
    <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>error <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        println <span style="color:#e6db74">&#34;ERROR installing ${shortName}, ${error}&#34;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">null</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// Check the update site(s) for latest plugins
</span><span style="color:#75715e"></span>println <span style="color:#960050;background-color:#1e0010">&#39;</span>Checking plugin updates via Plugin Manager<span style="color:#f92672">.</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
Jenkins<span style="color:#f92672">.</span><span style="color:#a6e22e">instance</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pluginManager</span><span style="color:#f92672">.</span><span style="color:#a6e22e">doCheckUpdatesServer</span><span style="color:#f92672">()</span>

<span style="color:#75715e">// Any plugins need updating?
</span><span style="color:#75715e"></span>Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> plugins_to_update <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>
plugins<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>it<span style="color:#f92672">.</span><span style="color:#a6e22e">hasUpdate</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        plugins_to_update <span style="color:#f92672">&lt;&lt;</span> it<span style="color:#f92672">.</span><span style="color:#a6e22e">getShortName</span><span style="color:#f92672">()</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>plugins_to_update<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    println <span style="color:#e6db74">&#34;Updating plugins...&#34;</span>
    plugins_to_update<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span>
        install_plugin<span style="color:#f92672">(</span>it<span style="color:#f92672">,</span> updateSite<span style="color:#f92672">)</span>
    <span style="color:#f92672">}</span>
    println <span style="color:#e6db74">&#34;Done updating plugins.&#34;</span>
    hasConfigBeenUpdated <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// Get a list of installed plugins
</span><span style="color:#75715e"></span>Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> installed_plugins <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>
plugins<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span>
    installed_plugins <span style="color:#f92672">&lt;&lt;</span> it<span style="color:#f92672">.</span><span style="color:#a6e22e">getShortName</span><span style="color:#f92672">()</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// Check to see if there are missing plugins to install
</span><span style="color:#75715e"></span>Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> missing_plugins <span style="color:#f92672">=</span> plugins_to_install <span style="color:#f92672">-</span> installed_plugins
<span style="color:#a6e22e">if</span><span style="color:#f92672">(</span>missing_plugins<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    println <span style="color:#e6db74">&#34;Install missing plugins...&#34;</span>
    missing_plugins<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span>
        install_plugin<span style="color:#f92672">(</span>it<span style="color:#f92672">,</span> updateSite<span style="color:#f92672">)</span>
    <span style="color:#f92672">}</span>
    println <span style="color:#e6db74">&#34;Done installing missing plugins.&#34;</span>
    hasConfigBeenUpdated <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>hasConfigBeenUpdated<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    println <span style="color:#e6db74">&#34;Saving Jenkins configuration to disk.&#34;</span>
    Jenkins<span style="color:#f92672">.</span><span style="color:#a6e22e">instance</span><span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">()</span>
    Jenkins<span style="color:#f92672">.</span><span style="color:#a6e22e">instance</span><span style="color:#f92672">.</span><span style="color:#a6e22e">restart</span><span style="color:#f92672">()</span>
<span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
    println <span style="color:#e6db74">&#34;Jenkins up-to-date. Nothing to do.&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Вторым по счету запускается скрипт <code>01-global-settings.groovy</code>, устанавливающий количество исполнителей, локаль, глобальные настройки для системы контроля версий и протоколы взаимодействия:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> jenkins.model.*
<span style="color:#f92672">import</span> org.jenkinsci.plugins.*
<span style="color:#f92672">import</span> hudson.security.csrf.DefaultCrumbIssuer
<span style="color:#f92672">import</span> hudson.plugins.locale.PluginImpl

def instance <span style="color:#f92672">=</span> Jenkins<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">()</span>

println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;--- Configuring global getting&#34;</span><span style="color:#f92672">)</span>
instance<span style="color:#f92672">.</span><span style="color:#a6e22e">setNumExecutors</span><span style="color:#f92672">(</span>5<span style="color:#f92672">)</span>
instance<span style="color:#f92672">.</span><span style="color:#a6e22e">setCrumbIssuer</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> DefaultCrumbIssuer<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">))</span>
instance<span style="color:#f92672">.</span><span style="color:#a6e22e">setNoUsageStatistics</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
instance<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">()</span>

println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;--- Configuring locale&#34;</span><span style="color:#f92672">)</span>
PluginImpl localePlugin <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>PluginImpl<span style="color:#f92672">)</span>instance<span style="color:#f92672">.</span><span style="color:#a6e22e">getPlugin</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;locale&#34;</span><span style="color:#f92672">)</span>
localePlugin<span style="color:#f92672">.</span><span style="color:#a6e22e">systemLocale</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;en_US&#34;</span>
localePlugin<span style="color:#f92672">.</span><span style="color:#a6e22e">@ignoreAcceptLanguage</span><span style="color:#f92672">=</span><span style="color:#66d9ef">true</span>

<span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;--- Configuring git global options&#34;</span><span style="color:#f92672">)</span>
def desc <span style="color:#f92672">=</span> instance<span style="color:#f92672">.</span><span style="color:#a6e22e">getDescriptor</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hudson.plugins.git.GitSCM&#34;</span><span style="color:#f92672">)</span>
desc<span style="color:#f92672">.</span><span style="color:#a6e22e">setGlobalConfigName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jenkins&#34;</span><span style="color:#f92672">)</span>
desc<span style="color:#f92672">.</span><span style="color:#a6e22e">setGlobalConfigEmail</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jenkins@example.com&#34;</span><span style="color:#f92672">)</span>
desc<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">()</span>

println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;--- Configuring protocols&#34;</span><span style="color:#f92672">)</span>
Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> agentProtocolsList <span style="color:#f92672">=</span> <span style="color:#f92672">[</span><span style="color:#960050;background-color:#1e0010">&#39;</span>JNLP4<span style="color:#f92672">-</span>connect<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">,</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>Ping<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">]</span>
<span style="color:#66d9ef">if</span><span style="color:#f92672">(!</span>instance<span style="color:#f92672">.</span><span style="color:#a6e22e">getAgentProtocols</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>agentProtocolsList<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    instance<span style="color:#f92672">.</span><span style="color:#a6e22e">setAgentProtocols</span><span style="color:#f92672">(</span>agentProtocolsList<span style="color:#f92672">)</span>
    println <span style="color:#e6db74">&#34;Agent Protocols have changed.  Setting: ${agentProtocolsList}&#34;</span>
    instance<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">()</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
    println <span style="color:#e6db74">&#34;Nothing changed.  Agent Protocols already configured: ${instance.getAgentProtocols()}&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Следующим будет выполнен скрипт с именем <code>02-disable-cli.groovy</code> (как несложно догадаться, отключающий CLI):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> jenkins.*
<span style="color:#f92672">import</span> jenkins.model.*
<span style="color:#f92672">import</span> hudson.model.*
<span style="color:#f92672">import</span> java.util.logging.Logger
<span style="color:#f92672">import</span> org.jenkinsci.main.modules.sshd.*
Logger logger <span style="color:#f92672">=</span> Logger<span style="color:#f92672">.</span><span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span>

<span style="color:#75715e">// Disable CLI access over TCP listener (separate port)
</span><span style="color:#75715e"></span>def p <span style="color:#f92672">=</span> AgentProtocol<span style="color:#f92672">.</span><span style="color:#a6e22e">all</span><span style="color:#f92672">()</span>
p<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> x <span style="color:#f92672">-&gt;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">.</span><span style="color:#a6e22e">name</span><span style="color:#f92672">?.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CLI&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        logger<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Removing protocol ${x.name}&#34;</span><span style="color:#f92672">)</span>
        p<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>x<span style="color:#f92672">)</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// Disable CLI access over /cli URL
</span><span style="color:#75715e"></span>def removal <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> lst <span style="color:#f92672">-&gt;</span>
    lst<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> x <span style="color:#f92672">-&gt;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">name</span><span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CLIAction&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            logger<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Removing extension ${x.getClass().name}&#34;</span><span style="color:#f92672">)</span>
            lst<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>x<span style="color:#f92672">)</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

def j <span style="color:#f92672">=</span> Jenkins<span style="color:#f92672">.</span><span style="color:#a6e22e">instance</span>
<span style="color:#a6e22e">removal</span><span style="color:#f92672">(</span>j<span style="color:#f92672">.</span><span style="color:#a6e22e">getExtensionList</span><span style="color:#f92672">(</span>RootAction<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">))</span>
removal<span style="color:#f92672">(</span>j<span style="color:#f92672">.</span><span style="color:#a6e22e">actions</span><span style="color:#f92672">)</span>

<span style="color:#75715e">// Disable CLI over Remoting
</span><span style="color:#75715e"></span>jenkins<span style="color:#f92672">.</span><span style="color:#a6e22e">CLI</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setEnabled</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>

<span style="color:#75715e">// Allow SSH connections
</span><span style="color:#75715e"></span>def sshdExtension <span style="color:#f92672">=</span> Jenkins<span style="color:#f92672">.</span><span style="color:#a6e22e">instance</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getExtensionList</span><span style="color:#f92672">(</span>SSHD<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)[</span>0<span style="color:#f92672">]</span>
sshdExtension<span style="color:#f92672">.</span><span style="color:#a6e22e">setPort</span><span style="color:#f92672">(</span>22222<span style="color:#f92672">)</span>
sshdExtension<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">()</span>

<span style="color:#75715e">// Configure Slave-to-Master Access Control
</span><span style="color:#75715e">// https://wiki.jenkins-ci.org/display/JENKINS/Slave+To+Master+Access+Control
</span><span style="color:#75715e"></span>
def rule <span style="color:#f92672">=</span> Jenkins<span style="color:#f92672">.</span><span style="color:#a6e22e">instance</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getExtensionList</span><span style="color:#f92672">(</span>jenkins<span style="color:#f92672">.</span><span style="color:#a6e22e">security</span><span style="color:#f92672">.</span><span style="color:#a6e22e">s2m</span><span style="color:#f92672">.</span><span style="color:#a6e22e">MasterKillSwitchConfiguration</span><span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)[</span>0<span style="color:#f92672">].</span><span style="color:#a6e22e">rule</span>
<span style="color:#a6e22e">if</span><span style="color:#f92672">(!</span>rule<span style="color:#f92672">.</span><span style="color:#a6e22e">getMasterKillSwitch</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    rule<span style="color:#f92672">.</span><span style="color:#a6e22e">setMasterKillSwitch</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
    logger<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">&#39;</span>Disabled agent <span style="color:#f92672">-&gt;</span> master security <span style="color:#66d9ef">for</span> cobertura<span style="color:#f92672">.</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
    logger<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">&#39;</span>Nothing changed<span style="color:#f92672">.</span>  Agent <span style="color:#f92672">-&gt;</span> master security already disabled<span style="color:#f92672">.</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// Do not annoy with Slave-to-Master Access Control warning
</span><span style="color:#75715e"></span>Jenkins<span style="color:#f92672">.</span><span style="color:#a6e22e">instance</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getExtensionList</span><span style="color:#f92672">(</span>jenkins<span style="color:#f92672">.</span><span style="color:#a6e22e">security</span><span style="color:#f92672">.</span><span style="color:#a6e22e">s2m</span><span style="color:#f92672">.</span><span style="color:#a6e22e">MasterKillSwitchWarning</span><span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)[</span>0<span style="color:#f92672">].</span><span style="color:#a6e22e">disable</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
Jenkins<span style="color:#f92672">.</span><span style="color:#a6e22e">instance</span><span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">()</span>
</code></pre></div><p>И, наконец, скрипт <code>03-user-service.groovy</code> создает пользователя и добавляет ему ssh-ключ для доступа к системе контроля версий:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">public_key <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>ssh<span style="color:#f92672">-</span>rsa AAAAB3N<span style="color:#f92672">....</span><span style="color:#a6e22e">TJChv</span> jenkins<span style="color:#960050;background-color:#1e0010">&#39;</span>
user <span style="color:#f92672">=</span> hudson<span style="color:#f92672">.</span><span style="color:#a6e22e">model</span><span style="color:#f92672">.</span><span style="color:#a6e22e">User</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">&#39;</span>service<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">)</span>
user<span style="color:#f92672">.</span><span style="color:#a6e22e">setFullName</span><span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">&#39;</span>Service User<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">)</span>
keys <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> org<span style="color:#f92672">.</span><span style="color:#a6e22e">jenkinsci</span><span style="color:#f92672">.</span><span style="color:#a6e22e">main</span><span style="color:#f92672">.</span><span style="color:#a6e22e">modules</span><span style="color:#f92672">.</span><span style="color:#a6e22e">cli</span><span style="color:#f92672">.</span><span style="color:#a6e22e">auth</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ssh</span><span style="color:#f92672">.</span><span style="color:#a6e22e">UserPropertyImpl</span><span style="color:#f92672">(</span>public_key<span style="color:#f92672">)</span>
user<span style="color:#f92672">.</span><span style="color:#a6e22e">addProperty</span><span style="color:#f92672">(</span>keys<span style="color:#f92672">)</span>
user<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">()</span>
</code></pre></div><p>На этом с настройкой экземпляра Jenkins под собственные нужды все, в <a href="https://ealebed.github.io/posts/2018/jenkins-as-a-code-%D1%87%D0%B0%D1%81%D1%82%D1%8C-2/">следующей статье</a> рассмотрим автоматическую настройку общих библиотек (<a href="https://ealebed.github.io/posts/2018/jenkins-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-shared-libraries/">Shared Libraries</a>) при запуске Jenkins.</p>
                </section>
            </article>

            
                <a class="twitter" href="https://twitter.com/intent/tweet?text=https%3a%2f%2fealebed.github.io%2fposts%2f2018%2fjenkins-as-a-code-%25D1%2587%25D0%25B0%25D1%2581%25D1%2582%25D1%258C-1%2f - Jenkins%20as%20a%20code.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%201 by @ealebed"><span class="icon-twitter"> tweet</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

            

            
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ealebed'; 

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

            

            
                <ul id="post-list" class="archive readmore">
    <h3>Read more</h3>

    
    
    
        <li>
            <a href="https://ealebed.github.io/posts/2021/healthcheck-for-apache-airflow-in-k8s-cluster/">Healthcheck для Apache Airflow в Kubernetes кластере<aside class="dates">Aug 26 2021</aside></a>
        </li>
    
        <li>
            <a href="https://ealebed.github.io/posts/2021/apache-airflow-and-slack-integration/">Интеграция Apache Airflow и Slack для отправки уведомлений<aside class="dates">Jul 12 2021</aside></a>
        </li>
    
        <li>
            <a href="https://ealebed.github.io/posts/2021/apache-airflow-%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA-kubernetespodoperator-%D1%87%D0%B5%D1%80%D0%B5%D0%B7-api/">Apache Airflow: запуск Kubernetes Pod Operator через API<aside class="dates">May 22 2021</aside></a>
        </li>
    
        <li>
            <a href="https://ealebed.github.io/posts/2021/%D0%B1%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%B0%D1%8F-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0-%D1%81-%D1%81%D0%B5%D0%BA%D1%80%D0%B5%D1%82%D0%B0%D0%BC%D0%B8-%D0%BF%D1%80%D0%B8-%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B5-docker-%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BE%D0%B2/">Безопасная работа с секретами при сборке docker-образов<aside class="dates">Apr 30 2021</aside></a>
        </li>
    
        <li>
            <a href="https://ealebed.github.io/posts/2021/%D0%B2%D0%B0%D0%BB%D0%B8%D0%B4%D0%B0%D1%86%D0%B8%D1%8F-%D0%BC%D0%B8%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D0%B9-flyway-%D1%81-%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E-testcontainers/">Валидация миграций flyway c помощью testcontainers<aside class="dates">Feb 5 2021</aside></a>
        </li>
    
</ul>

            

            <footer id="footer">
    
        <div id="social">
	
	
    <a class="symbol" href="https://www.facebook.com/ealebed">
        <i class="fa fa-facebook-square"></i>
    </a>
    
    <a class="symbol" href="https://www.github.com/ealebed">
        <i class="fa fa-github-square"></i>
    </a>
    
    <a class="symbol" href="https://www.linkedin.com/in/ealebed/">
        <i class="fa fa-linkedin-square"></i>
    </a>
    
    <a class="symbol" href="https://www.twitter.com/ealebed">
        <i class="fa fa-twitter-square"></i>
    </a>
    

</div>

    
    <p class="small">
    
       © Copyright 2021 <i class="fa fa-heart" aria-hidden="true"></i> Yevhen Lebid
    
    </p>
</footer>

        </section>

        <script src="https://ealebed.github.io/js/jquery-2.2.4.min.js"></script>
<script src="https://ealebed.github.io/js/main.js"></script>
<script src="https://ealebed.github.io/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>





    </body>
</html>
